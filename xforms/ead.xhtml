<?xml version="1.0" encoding="utf-8"?>
<!--
    Author: Ethan Gruber
    EADitor: https://github.com/ewg118/eaditor
    Function: EAD core XForms editor (EAD Header, Archdesc)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:eaditor="https://github.com/ewg118/eaditor"
	xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xxi="http://orbeon.org/oxf/xml/xinclude" xmlns:ead="urn:isbn:1-931666-22-9" xmlns:exist="http://exist.sourceforge.net/NS/exist"
	xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
	<head>
		<title>EADitor: Edit Guide</title>
		<link rel="stylesheet" href="/fr/style/bootstrap/css/bootstrap.css" type="text/css" />
		<link rel="stylesheet" href="/fr/style/form-runner-bootstrap-override.css" type="text/css" />
		<link rel="shortcut icon" href="/ops/images/orbeon-icon-16.ico" />
		<link rel="icon" href="/ops/images/orbeon-icon-16.png" type="image/png" />
		<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
		<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="/apps/eaditor/xforms/css/xforms.css" />

		<xforms:model xmlns="urn:isbn:1-931666-22-9">
			<xs:schema elementFormDefault="qualified" attributeFormDefault="unqualified">
				<xs:simpleType name="iso8601date">
					<xs:restriction base="xs:string">
						<xs:pattern
							value="(\-?(0|1|2)([0-9]{3})(((01|02|03|04|05|06|07|08|09|10|11|12)((0[1-9])|((1|2)[0-9])|(3[0-1])))|\-((01|02|03|04|05|06|07|08|09|10|11|12)(\-((0[1-9])|((1|2)[0-9])|(3[0-1])))?))?)\/?(\-?(0|1|2)([0-9]{3})(((01|02|03|04|05|06|07|08|09|10|11|12)((0[1-9])|((1|2)[0-9])|(3[0-1])))|\-((01|02|03|04|05|06|07|08|09|10|11|12)(\-((0[1-9])|((1|2)[0-9])|(3[0-1])))?))?)?"
						></xs:pattern>
					</xs:restriction>
				</xs:simpleType>
			</xs:schema>

			<xforms:instance id="guide">
				<ead xmlns="urn:isbn:1-931666-22-9" xmlns:xlink="http://www.w3.org/1999/xlink">
					<eadheader langencoding="">
						<eadid countrycode=""></eadid>
					</eadheader>
				</ead>
			</xforms:instance>

			<!-- exist URL is stored in an XML file -->
			<xforms:instance id="exist-config">
				<xi:include href="../exist-config.xml"></xi:include>
			</xforms:instance>

			<xforms:instance id="config" xxforms:exclude-result-prefixes="#all">
				<config></config>
			</xforms:instance>
			
			<xforms:instance id="master-config" xxforms:exclude-result-prefixes="#all">
				<config></config>
			</xforms:instance>

			<xforms:instance id="control-instance">
				<controls xmlns="">
					<collection-name></collection-name>
					<status></status>
					<url/>
					<!-- Solr file indexing -->
					<stream-url/>
					<content-type/>
					<new>true</new>
				</controls>
			</xforms:instance>

			<xforms:instance id="dump">
				<dump xmlns=""></dump>
			</xforms:instance>

			<!-- get template from eXist -->
			<xforms:instance id="c-template">
				<c xmlns="urn:isbn:1-931666-22-9"></c>
			</xforms:instance>

			<!-- xquery to get next number in sequence -->
			<xforms:instance id="eXist-xquery">
				<exist:query xmlns="">
					<exist:text></exist:text>
				</exist:query>
			</xforms:instance>

			<xforms:instance id="xqueries">
				<queries xmlns="">
					<query id="get-ids">&lt;report> { for $foo in collection() where $foo[descendant::ead:eadid/@mainagencycode='AGENCYCODE'] order by $foo//ead:eadid return &lt;item> {
						data($foo//*[local-name()='eadid']) } &lt;/item> } &lt;/report></query>
				</queries>
			</xforms:instance>

			<xforms:instance id="xquery-result">
				<exist:result></exist:result>
			</xforms:instance>

			<!-- solr response for id query -->
			<xforms:instance id="is-published">
				<response xmlns=""></response>
			</xforms:instance>
			<!-- send to Solr -->
			<xforms:instance id="addIndex">
				<add xmlns=""></add>
			</xforms:instance>
			<!-- Instance for Solr commit-->
			<xforms:instance id="sendCommit">
				<commit></commit>
			</xforms:instance>
			
			<xforms:instance id="request">
				<request xmlns=""></request>
			</xforms:instance>

			<!-- linked data publication instances -->
			<xforms:instance id="rdf" xxforms:exclude-result-prefixes="#all">
				<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"></rdf:RDF>
			</xforms:instance>

			<xforms:instance id="sparqlUpdate-template">
				<query>
					<![CDATA[PREFIX dcterms:	<http://purl.org/dc/terms/>
PREFIX edm:	<http://www.europeana.eu/schemas/edm/>
PREFIX svcs:	<http://rdfs.org/sioc/services#>
DELETE {?s ?p ?o} WHERE {
{?c dcterms:isPartOf+ <URI> .
?c edm:isShownBy ?image .
?image svcs:has_service ?s . ?s ?p ?o}
UNION {?c dcterms:isPartOf+ <URI> .
?c edm:isShownBy ?s . ?s ?p ?o}
UNION {?s dcterms:isPartOf+ <URI> . ?s ?p ?o}
UNION {<URI> ?p ?o . ?s ?p ?o FILTER (?s = <URI>)}}]]>
				</query>
			</xforms:instance>

			<xforms:instance id="sparqlUpdate">
				<query></query>
			</xforms:instance>

			<!-- table of contents for navigation -->
			<xforms:instance id="toc">
				<dsc xmlns=""></dsc>
			</xforms:instance>

			<!-- EAD ELEMENTS -->
			<!-- eadheader -->
			<xforms:instance id="profiledesc-template" xxforms:exclude-result-prefixes="#all">
				<profiledesc></profiledesc>
			</xforms:instance>
			<xforms:instance id="revisiondesc-template" xxforms:exclude-result-prefixes="#all">
				<revisiondesc>
					<change>
						<date normal=""></date>
						<item></item>
					</change>
				</revisiondesc>
			</xforms:instance>
			<xforms:instance id="editionstmt-template" xxforms:exclude-result-prefixes="#all">
				<editionstmt>
					<edition></edition>
				</editionstmt>
			</xforms:instance>
			<xforms:instance id="notestmt-template" xxforms:exclude-result-prefixes="#all">
				<notestmt>
					<note>
						<p></p>
					</note>
				</notestmt>
			</xforms:instance>
			<xforms:instance id="publicationstmt-template" xxforms:exclude-result-prefixes="#all">
				<publicationstmt></publicationstmt>
			</xforms:instance>
			<xforms:instance id="seriesstmt-template" xxforms:exclude-result-prefixes="#all">
				<seriesstmt></seriesstmt>
			</xforms:instance>

			<!-- shared/generic -->
			<xforms:instance id="author-template" xxforms:exclude-result-prefixes="#all">
				<author></author>
			</xforms:instance>
			<xforms:instance id="creation-template" xxforms:exclude-result-prefixes="#all">
				<creation></creation>
			</xforms:instance>
			<xforms:instance id="change-template" xxforms:exclude-result-prefixes="#all">
				<change>
					<date normal=""></date>
					<item></item>
				</change>
			</xforms:instance>
			<xforms:instance id="date-template" xxforms:exclude-result-prefixes="#all">
				<date normal=""></date>
			</xforms:instance>
			<xforms:instance id="descrules-template" xxforms:exclude-result-prefixes="#all">
				<descrules></descrules>
			</xforms:instance>
			<xforms:instance id="langusage-template" xxforms:exclude-result-prefixes="#all">
				<langusage></langusage>
			</xforms:instance>
			<xforms:instance id="num-template" xxforms:exclude-result-prefixes="#all">
				<num type=""></num>
			</xforms:instance>
			<xforms:instance id="publisher-template" xxforms:exclude-result-prefixes="#all">
				<publisher></publisher>
			</xforms:instance>
			<xforms:instance id="sponsor-template" xxforms:exclude-result-prefixes="#all">
				<sponsor></sponsor>
			</xforms:instance>
			<xforms:instance id="subtitle-template" xxforms:exclude-result-prefixes="#all">
				<subtitle></subtitle>
			</xforms:instance>
			<xforms:instance id="titleproper-template" xxforms:exclude-result-prefixes="#all">
				<titleproper></titleproper>
			</xforms:instance>
			<xforms:instance id="address-template" xxforms:exclude-result-prefixes="#all">
				<address>
					<addressline></addressline>
				</address>
			</xforms:instance>
			<xforms:instance id="blockquote-template" xxforms:exclude-result-prefixes="#all">
				<blockquote></blockquote>
			</xforms:instance>
			<xforms:instance id="head-template" xxforms:exclude-result-prefixes="#all">
				<head></head>
			</xforms:instance>
			<xforms:instance id="note-template" xxforms:exclude-result-prefixes="#all">
				<note>
					<p></p>
				</note>
			</xforms:instance>
			<xforms:instance id="p-template" xxforms:exclude-result-prefixes="#all">
				<p></p>
			</xforms:instance>

			<!-- archdesc instances -->
			<xforms:instance id="dsc-template" xxforms:exclude-result-prefixes="#all">
				<dsc></dsc>
			</xforms:instance>
			
			<!-- uploading a file into an otherfindaid -->
			<xforms:instance id="upload-template" xxforms:exclude-result-prefixes="#all">
				<otherfindaid type="eaditor_upload">
					<bibref>
						<extptr xlink:type="simple" xlink:href="" xlink:role=""/>
					</bibref>
				</otherfindaid>
			</xforms:instance>

			<xforms:instance id="level-template">
				<levels xmlns="">
					<level value="">Select...</level>
					<level value="class">Class</level>
					<level value="collection">Collection</level>
					<level value="file">File</level>
					<level value="fonds">Fonds</level>
					<level value="item">Item</level>
					<level value="recordgrp">Record Group</level>
					<level value="series">Series</level>
					<level value="subfonds">Subfonds</level>
					<level value="subgrp">Subgroup</level>
					<level value="subseries">Subseries</level>
					<level value="otherlevel">Other Level</level>
				</levels>
			</xforms:instance>

			<!-- ************** BINDINGS ********************-->
			<xforms:bind node="instance('guide')">
				<xforms:bind nodeset="//*/@id" type="xs:ID"></xforms:bind>
				<xforms:bind nodeset="ead:eadheader">
					<xforms:bind nodeset="ead:eadid" type="xs:ID" required="true()">
						<xforms:bind nodeset="@countrycode">
							<xforms:bind constraint="string-length(.) &gt; 0"></xforms:bind>
						</xforms:bind>
						<xforms:bind nodeset="@mainagencycode">
							<xforms:bind constraint="string-length(.) &gt; 0"></xforms:bind>
						</xforms:bind>
					</xforms:bind>
					<xforms:bind nodeset="ead:filedesc">
						<xforms:bind nodeset="ead:titlestmt">
							<xforms:bind nodeset="ead:titleproper" required="true()"></xforms:bind>
							<xforms:bind nodeset="ead:author" required="true()"></xforms:bind>
						</xforms:bind>
						<xforms:bind nodeset="ead:publicationstmt">
							<xforms:bind nodeset="ead:publisher" required="true()"></xforms:bind>
							<xforms:bind nodeset="ead:address/ead:addressline" required="true()"></xforms:bind>
						</xforms:bind>
					</xforms:bind>
					<xforms:bind nodeset="ead:profiledesc">
						<xforms:bind nodeset="ead:creation" required="true()"></xforms:bind>
						<xforms:bind nodeset="ead:langusage" required="true()"></xforms:bind>
					</xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="ead:archdesc">
					<xforms:bind nodeset="@level" required="true()"></xforms:bind>
					<xforms:bind nodeset="ead:did">
						<xforms:bind nodeset="ead:origination" constraint="count(*) &gt; 0">
							<xforms:bind nodeset="*" required="true()"/>
						</xforms:bind>
						<xforms:bind nodeset="ead:unitid" required="true()"></xforms:bind>
						<xforms:bind nodeset="ead:repository">
							<xforms:bind nodeset="ead:corpname" required="true()"/>
							<xforms:bind nodeset="ead:subarea" required="true()"/>
						</xforms:bind>
						<xforms:bind nodeset="ead:langmaterial">
							<xforms:bind ref="ead:language">
								<xforms:bind constraint="string-length(@langcode) &gt; 0"></xforms:bind>
							</xforms:bind>
						</xforms:bind>
						<xforms:bind nodeset="ead:physdesc">
							<xforms:bind nodeset="ead:extent" required="true()"></xforms:bind>
						</xforms:bind>
						<xforms:bind nodeset="ead:abstract" required="true()"></xforms:bind>
					</xforms:bind>
					<xforms:bind nodeset="ead:dsc">
						<xforms:bind nodeset="ead:c">
							<xforms:bind nodeset="@id" required="true()"></xforms:bind>
							<xforms:bind nodeset="@level" required="true()"></xforms:bind>
							<xforms:bind nodeset="@otherlevel" type="xs:NMTOKEN"></xforms:bind>
						</xforms:bind>
					</xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="//ead:tgroup/@cols" required="true()" type="xs:integer"></xforms:bind>
				<xforms:bind nodeset="//ead:listhead">
					<xforms:bind nodeset="ead:head01" required="true()"></xforms:bind>
					<xforms:bind nodeset="ead:head02" required="true()"></xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="//ead:ref" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:extref" required="true()">
					<xforms:bind nodeset="@xlink:href" required="true()" type="xs:anyURI"></xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="//ead:extptr/@xlink:href" required="true()" type="xs:anyURI"></xforms:bind>
				<xforms:bind nodeset="//ead:dao/@xlink:href" required="true()" type="xs:anyURI"></xforms:bind>
				<xforms:bind nodeset="//ead:daoloc/@xlink:href" required="true()" type="xs:anyURI"></xforms:bind>
				<xforms:bind nodeset="//ead:daoloc/@xlink:label" constraint="string-length(.) &gt; 0"></xforms:bind>
				<xforms:bind nodeset="//ead:daodesc">
					<xforms:bind nodeset="ead:head" required="true()"></xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="//ead:defitem">
					<xforms:bind nodeset="ead:label" required="true()"></xforms:bind>
					<xforms:bind nodeset="ead:item" required="true()"></xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="//ead:unittitle" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:unitdate" required="true()">
					<xforms:bind nodeset="@normal" type="iso8601date"></xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="//ead:date" required="true()">
					<xforms:bind nodeset="@normal" type="iso8601date"></xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="//ead:p" constraint="string-length(.) &gt; 0"></xforms:bind>
				<xforms:bind nodeset="//ead:head" required="true()"></xforms:bind>
				<!-- require content for controlled access headings -->
				<xforms:bind nodeset="//ead:corpname" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:famname" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:function" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:genreform" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:geogname" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:name" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:occupation" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:persname" required="true()"></xforms:bind>
				<xforms:bind nodeset="//ead:subject" required="true()"></xforms:bind>
			</xforms:bind>
			
			<xforms:bind nodeset="instance('control-instance')">
				<xforms:bind nodeset="new" type="xs:boolean"/>
			</xforms:bind>

			<!-- bind tabs -->
			<xforms:bind id="archdesc-tab" nodeset="instance('guide')/ead:archdesc"></xforms:bind>

			<!-- ************** SUBMISSIONS ***************** -->
			<!-- load preliminary instances -->
			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/config.xml"
				replace="instance" instance="config" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error loading config.</xforms:message>
			</xforms:submission>
			
			<xforms:submission id="load-master-config" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/config.xml"
				replace="instance" instance="master-config" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error loading master config.</xforms:message>
			</xforms:submission>

			<xforms:submission id="load-ead-template" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/ead-template.xml"
				replace="instance" instance="guide" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load EAD core template.</xforms:message>
				<!-- set date on new document -->
				<xforms:action ev:event="xforms-submit-done">
					<!-- automatically set eadid -->
					<xforms:setvalue ref="instance('eXist-xquery')/exist:text" value="replace(instance('xqueries')/query[@id='get-ids'], 'AGENCYCODE', instance('guide')//ead:eadid/@mainagencycode)"></xforms:setvalue>
					<xforms:send submission="xquery-collection"></xforms:send>
					<!-- process results -->
					<xforms:action ev:event="xforms-submit-done">
						<xforms:var name="code" select="substring-after(instance('guide')//ead:eadid/@mainagencycode, '-')"></xforms:var>
						<xforms:action if="count(instance('xquery-result')//item) &gt; 0">
							<xforms:var name="number" select="number(substring-after(instance('xquery-result')//item[last()], $code))"></xforms:var>
							<xforms:setvalue ref="instance('guide')/ead:eadheader/ead:eadid" value="concat($code, format-number($number+1, '0000'))"></xforms:setvalue>
						</xforms:action>
						<xforms:action if="count(instance('xquery-result')//item) = 0">
							<xforms:setvalue ref="instance('guide')/ead:eadheader/ead:eadid" value="concat($code, '0001')"></xforms:setvalue>
						</xforms:action>
					</xforms:action>

					<!-- only need to set @normal; date XBL will handle human readability -->
					<xforms:setvalue ref="instance('guide')/ead:eadheader/ead:filedesc/ead:publicationstmt/ead:date/@normal" value="substring(string(current-date()), 1, 10)"></xforms:setvalue>

					<!-- set other values for new finding aids -->
					<xforms:setvalue ref="instance('guide')/ead:eadheader/ead:profiledesc/ead:creation" value="concat('Finding aid created with EADitor by user ', xxforms:get-remote-user(), '.')"></xforms:setvalue>
					<xforms:insert context="instance('guide')/ead:archdesc/ead:did/ead:unitdate" origin="xforms:attribute('type', 'inclusive')"></xforms:insert>
				</xforms:action>
			</xforms:submission>

			<xforms:submission id="load-c-template" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/c-template.xml"
				replace="instance" instance="c-template" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load component template.</xforms:message>
			</xforms:submission>

			<!-- Submission to get the document -->
			<xforms:submission id="load-guide" serialization="none" method="get"
				action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/guides/{instance('guide')/ead:eadheader/ead:eadid}.xml" replace="instance" instance="guide"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load finding aid</xforms:message>
				<xforms:send submission="load-toc" ev:event="xforms-submit-done"></xforms:send>
			</xforms:submission>

			<!-- load table of contents after loading the ead guide -->
			<xforms:submission id="load-toc" serialization="none" method="get"
				action="/eaditor/admin/toc/?collection={instance('control-instance')/collection-name}&amp;guide={instance('guide')/ead:eadheader/ead:eadid}" replace="instance" instance="toc">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load table of contents</xforms:message>
			</xforms:submission>

			<!-- Submission to save the document -->
			<xforms:submission id="save-guide" ref="instance('guide')"
				action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/guides/{instance('guide')/ead:eadheader/ead:eadid}.xml" method="put" replace="none"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error Saving Documents. Be sure all required inputs are filled in.</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('control-instance')/status">EAD guide saved.</xforms:setvalue>
					<!-- check to see if the document is already published to Solr -->
					<xforms:send submission="query-solr-for-publication"></xforms:send>
					<!-- reload toc -->
					<xforms:send submission="load-toc"></xforms:send>
				</xforms:action>
			</xforms:submission>

			<!-- ************** SOLR ***************** -->
			<!-- submission to query solr to see if the document is published -->
			<xforms:submission id="query-solr-for-publication" serialization="none" method="get"
				action="{instance('config')/solr_published}select/?q=id:&#x022;{instance('guide')/ead:eadheader/ead:eadid}&#x022;" replace="instance" instance="is-published">
				<!-- if the document is found in solr, get the updated solr doc -->
				<xforms:action ev:event="xforms-submit-done" if="instance('is-published')/result[@name='response']/@numFound = '1'">
					<!-- post doc to solr -->
					<xforms:var name="filename" select="instance('guide')/ead:archdesc/ead:otherfindaid[@type='eaditor_upload']/ead:bibref/ead:extptr/@xlink:href"/>
					<xforms:action if="string($filename)">
						<!-- set the document URL -->
						<xforms:insert nodeset="instance('request')" origin="xxforms:call-xpl('oxf:/apps/eaditor/xpl/get-request.xpl', 'file', instance('config'), 'data')"></xforms:insert>
						<xforms:setvalue ref="instance('control-instance')/stream-url" value="concat('http://', instance('request')/server-name, ':', instance('request')/server-port, '/orbeon/eaditor/uploads/', instance('control-instance')/collection-name, '/', $filename)"/>
						<xforms:setvalue ref="instance('control-instance')/content-type" value="instance('guide')/ead:archdesc/ead:otherfindaid[@type='eaditor_upload']/ead:bibref/ead:extptr/@xlink:role"/>
						
						<xforms:send submission="put-document"></xforms:send>
					</xforms:action>
					<xforms:action if="not(string($filename))">
						<xforms:send submission="doc-to-solr"></xforms:send>
					</xforms:action>
					
					<!-- update SPARQL -->
					<xforms:action if="string(instance('config')/sparql/update) and string(instance('config')/sparql/store)">
						<xforms:var name="uri"
							select="if (instance('config')/ark/@enabled='true') then concat(instance('config')/url, 'ark:/', instance('config')/ark/naan, '/', instance('guide')/ead:eadheader/ead:eadid) else concat(instance('config')/url, 'id/', instance('guide')/ead:eadheader/ead:eadid)"></xforms:var>
						<xforms:setvalue ref="instance('sparqlUpdate')" value="replace(instance('sparqlUpdate-template'), 'URI', $uri)"></xforms:setvalue>
						<xforms:send submission="delete-graph"></xforms:send>
					</xforms:action>
				</xforms:action>
			</xforms:submission>

			<!-- access service to read in pre-transformed solr doc -->
			<xforms:submission id="doc-to-solr" method="get" replace="instance" instance="addIndex" serialization="none"
				resource="/eaditor/{instance('control-instance')/collection-name}/id/{instance('guide')/ead:eadheader/ead:eadid}.solr">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error transforming EAD guide to Solr document.</xforms:message>
				<xforms:send ev:event="xforms-submit-done" submission="publish-submission"></xforms:send>
			</xforms:submission>

			<!-- post instance to Solr -->
			<xforms:submission id="publish-submission" action="{instance('config')/solr_published}update" ref="instance('addIndex')" instance="addIndex" replace="instance" method="post">
				<xforms:action ev:event="xforms-submit-done">
					<xforms:send submission="submit-commit"></xforms:send>
					<xforms:setvalue ref="instance('control-instance')/status">EAD guide saved and updated to search index.</xforms:setvalue>
				</xforms:action>
				<xforms:message ev:event="xforms-submit-error" level="modal">Data Failed to POST to Solr. Index may be offline or URL is incorrect.</xforms:message>
			</xforms:submission>
			
			<!-- post document file to Solr for fulltext indexing -->
			<xforms:submission id="put-document" ref="instance('dump')" method="post" replace="none"
				resource="{instance('config')/solr_published}update/extract?literal.id={instance('guide')/ead:eadheader/ead:eadid}&amp;stream.url={instance('control-instance')/stream-url}&amp;stream.contentType={instance('control-instance')/content-type}&amp;fmap.content=content&amp;commit=true">
				<xforms:header>
					<xforms:name>Content-type</xforms:name>
					<xforms:value ref="instance('control-instance')/content-type"></xforms:value>
				</xforms:header>
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to index the document file.</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('control-instance')/status">Document successfully saved to Solr.</xforms:setvalue>
					<xforms:send submission="doc-to-solr"></xforms:send>
				</xforms:action>
			</xforms:submission>

			<!-- send commit -->
			<xforms:submission id="submit-commit" action="{instance('config')/solr_published}update" ref="instance('sendCommit')" instance="sendCommit" replace="none" method="post"></xforms:submission>

			<!-- ************** XQUERY ***************** -->
			<xforms:submission id="xquery-collection" ref="instance('eXist-xquery')" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/guides/" method="post"
				replace="instance" instance="xquery-result">
				<xforms:setvalue ref="instance('control-instance')/error" ev:event="xforms-submit-error">Error querying eXist database.</xforms:setvalue>
			</xforms:submission>

			<!-- ************** POST RDF TO TRIPLESTORE ***************** -->
			<xforms:submission id="get-rdf" method="get" replace="instance" instance="rdf" serialization="none"
				resource="/eaditor/{instance('control-instance')/collection-name}/id/{instance('guide')/ead:eadheader/ead:eadid}.rdf">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to get RDF/XML serialization.</xforms:message>

				<!-- post RDF into SPARQL endpoint -->
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('control-instance')/status">Successfully published RDF to triplestore.</xforms:setvalue>
					<xforms:send submission="post-rdf"></xforms:send>
				</xforms:action>

			</xforms:submission>

			<xforms:submission id="post-rdf" action="{instance('config')/sparql/store}?default" ref="instance('rdf')" replace="none" method="post" mediatype="application/rdf+xml">
				<xforms:action ev:event="xforms-submit-error">
					<xforms:message level="modal">Post to endpoint failed.</xforms:message>
				</xforms:action>
			</xforms:submission>

			<xforms:submission id="delete-graph" action="{instance('config')/sparql/update}" ref="instance('sparqlUpdate')" serialization="text/plain" replace="none" method="post"
				mediatype="application/sparql-update">
				<xforms:action ev:event="xforms-submit-error">
					<xforms:message level="modal">SPARQL update failed.</xforms:message>
				</xforms:action>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('control-instance')/status">Object purged from triplestore.</xforms:setvalue>
					<xforms:send submission="get-rdf"></xforms:send>
				</xforms:action>
			</xforms:submission>

			<!-- ************************ xforms-model-construct-done ****************************** -->
			<!-- load id parameter from url into @id attribute for EAD guide -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:action if="string(xxforms:get-session-attribute('collection-name'))">
					<xforms:send submission="load-master-config"></xforms:send>
					
					<xforms:setvalue ref="instance('control-instance')/collection-name" value="xxforms:get-session-attribute('collection-name')"></xforms:setvalue>
					<xforms:send submission="load-config"></xforms:send>
					<xforms:send submission="load-c-template"></xforms:send>
					<!-- if there is a guide parameter, load existing finding aid -->
					<xforms:action if="string(xxforms:get-request-parameter('guide'))">
						<xforms:setvalue ref="instance('guide')/ead:eadheader/ead:eadid" value="xxforms:get-request-parameter('guide')"></xforms:setvalue>
						<xforms:send submission="load-guide"></xforms:send>
					</xforms:action>
					<!-- if not, load ead template -->
					<xforms:action if="not(string(xxforms:get-request-parameter('guide')))">
						<xforms:send submission="load-ead-template"></xforms:send>
					</xforms:action>
					
					<!-- set control instance URL dependent upon the collection being an aggregator -->
					<xforms:setvalue ref="instance('control-instance')/url" value="if (instance('master-config')/aggregator = 'true') then instance('master-config')/url else instance('config')/url"/>
				</xforms:action>
			</xforms:action>
		</xforms:model>

		<!-- xbl components -->
		<xi:include href="xbl/access-elements/access-elements.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/accessrestrict/accessrestrict.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/accruals/accruals.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/acqinfo/acqinfo.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/address/address.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/altformavail/altformavail.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/appraisal/appraisal.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/arrangement/arrangement.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/attributes/attributes.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/bibliography/bibliography.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/bibref/bibref.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/bioghist/bioghist.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/blockquote/blockquote.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/c/c.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/chronlist/chronlist.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/component-level/component-level.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/controlaccess/controlaccess.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/corpname/corpname.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/custodhist/custodhist.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/dao/dao.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/daogrp/daogrp.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/daoloc/daoloc.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/daodesc/daodesc.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/date/date.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/did/did.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/extptrloc/extptrloc.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/extref/extref.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/extptr/extptr.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/extrefloc/extrefloc.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/famname/famname.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/fileplan/fileplan.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/function/function.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/generic-elements/generic-elements.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/genreform/genreform.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/geogname/geogname.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/head/head.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/index/index.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/linkgrp/linkgrp.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/list/list.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/listhead/listhead.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/name/name.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/namegrp/namegrp.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/note/note.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/num/num.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/occupation/occupation.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/odd/odd.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/originalsloc/originalsloc.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/otherfindaid/otherfindaid.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/p/p.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/persname/persname.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/phystech/phystech.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/prefercite/prefercite.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/processinfo/processinfo.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/ptr/ptr.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/ptrgrp/ptrgrp.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/ptrloc/ptrloc.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/ref/ref.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/refloc/refloc.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/relatedmaterial/relatedmaterial.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/scopecontent/scopecontent.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/separatedmaterial/separatedmaterial.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/subject/subject.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/table/table.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/title/title.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/titleproper/titleproper.xbl" xxi:omit-xml-base="true"></xi:include>
		<xi:include href="xbl/userestrict/userestrict.xbl" xxi:omit-xml-base="true"></xi:include>

		<!-- navigation -->
		<xi:include href="xbl/navigation/navigation.xbl" xxi:omit-xml-base="true"></xi:include>
	</head>
	<body>
		<xforms:var name="display_path">../../</xforms:var>
		<xi:include href="header.xml"></xi:include>
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<xforms:group ref="instance('control-instance')/status/text()">
						<div class="alert-success alert alert-box">
							<span class="glyphicon glyphicon-info-sign"></span>
							<strong>Status:</strong>
							<xforms:output ref="instance('control-instance')/status"></xforms:output>
						</div>
					</xforms:group>
					<xforms:group ref=".[string(xxforms:get-session-attribute('flickr_username'))]">
						<!-- show username if there are already session parameters -->
						<div style="float:right">
							<b>
								<xforms:output value="xxforms:get-session-attribute('flickr_username')">
									<xforms:label>Flickr User</xforms:label>
								</xforms:output>
							</b>
						</div>
					</xforms:group>
					<p>
						<a href="{$display_path}"><span class="glyphicon glyphicon-arrow-left"/> Return</a>
					</p>
					<div class="section">
						<h1>Edit EAD Finding Aid</h1>
						<div class="submission">
							<xforms:submit submission="save-guide" appearance="minimal">
								<xforms:label><span class="glyphicon glyphicon-floppy-disk"></span>Save</xforms:label>
							</xforms:submit>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-2">
					<eaditor:navigation ref="instance('toc')" depth="8"></eaditor:navigation>
				</div>
				<div class="col-md-10">
					<div id="form">
						<div>
							<xforms:input ref="instance('guide')/ead:eadheader/ead:eadid">
								<xforms:label>EAD ID</xforms:label>
								<xforms:alert>The id is required</xforms:alert>
							</xforms:input>
						</div>
						<fr:tabview>
							<!--**************************************** EADHEADER **********************************-->
							<fr:tab id="eadheader-tab">
								<fr:label>Finding Aid Info</fr:label>
								<xforms:group ref="instance('guide')/ead:eadheader">
									<h1>Finding Aid Info</h1>
									<span class="add">
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<span class="glyphicon glyphicon-plus"></span>
											</xforms:label>
											<xxforms:show ev:event="DOMActivate" dialog="eadheader-objects"></xxforms:show>
										</xforms:trigger>
									</span>
									<p>Information about the creation, revision, and publication of the finding aid.</p>
									<xxforms:dialog id="eadheader-objects" appearance="full" level="modal" close="true" draggable="true" visible="false">
										<xforms:label>Available Elements</xforms:label>
										<xforms:group ref=".[count(ead:profiledesc) &lt; 1]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<span class="glyphicon glyphicon-plus"></span>Profile Description</xforms:label>
												<xforms:insert ev:event="DOMActivate" context="." nodeset="ead:filedesc" origin="instance('profiledesc-template')"></xforms:insert>
											</xforms:trigger>
										</xforms:group>
										<xforms:group ref=".[count(ead:revisiondesc) &lt; 1]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<span class="glyphicon glyphicon-plus"></span>Revision Description</xforms:label>
												<xforms:insert ev:event="DOMActivate" context="." nodeset="if (ead:profiledesc) then ead:profiledesc else ead:filedesc"
													origin="instance('revisiondesc-template')"></xforms:insert>
											</xforms:trigger>
										</xforms:group>
									</xxforms:dialog>
									<div class="section">
										<xforms:group ref=".[count(ead:eadid/@mainagencycode) &lt; 1]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<span class="glyphicon glyphicon-plus"></span>@mainagencycode</xforms:label>
												<xforms:insert ev:event="DOMActivate" context="ead:eadid" origin="xforms:attribute('mainagencycode', '')"></xforms:insert>
											</xforms:trigger>
										</xforms:group>
										<xforms:output ref="ead:eadid/@mainagencycode">
											<xforms:label>Agency Code</xforms:label>
										</xforms:output>
									</div>
									<div class="section">
										<h2>File Description</h2>
										<span class="add">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<span class="glyphicon glyphicon-plus"></span>
												</xforms:label>
												<xxforms:show ev:event="DOMActivate" dialog="filedesc-objects"></xxforms:show>
											</xforms:trigger>
										</span>
										<xxforms:dialog id="filedesc-objects" appearance="full" level="modal" close="true" draggable="true" visible="false">
											<xforms:label>File Description Elements</xforms:label>
											<xforms:group ref=".[count(//ead:editionstmt) &lt; 1]">
												<xforms:trigger appearance="minimal">
													<xforms:label>
														<span class="glyphicon glyphicon-plus"></span>Edition Statement</xforms:label>
													<xforms:insert ev:event="DOMActivate" context="ead:filedesc" nodeset="ead:titlestmt" position="after" origin="instance('editionstmt-template')"
													></xforms:insert>
												</xforms:trigger>
											</xforms:group>
											<xforms:group ref=".[count(//ead:seriesstmt) &lt; 1]">
												<xforms:trigger appearance="minimal">
													<xforms:label>
														<span class="glyphicon glyphicon-plus"></span>Series Statement</xforms:label>
													<xforms:insert ev:event="DOMActivate" context="ead:filedesc"
														nodeset="if (ead:publicationstmt) then ead:publicationstmt else if (ead:editionstmt) then ead:editionstmt else ead:titlestmt"
														origin="instance('seriesstmt-template')"></xforms:insert>
												</xforms:trigger>
											</xforms:group>
											<xforms:group ref=".[count(//ead:notestmt) &lt; 1]">
												<xforms:trigger appearance="minimal">
													<xforms:label>
														<span class="glyphicon glyphicon-plus"></span>Note Statement</xforms:label>
													<xforms:insert ev:event="DOMActivate" context="ead:filedesc" nodeset="./child::node()[last()]" origin="instance('notestmt-template')"
													></xforms:insert>
												</xforms:trigger>
											</xforms:group>
										</xxforms:dialog>
										<xforms:group ref="ead:filedesc">
											<xforms:group ref="ead:titlestmt">
												<div class="subsection">
													<h3>Title Statement</h3>
													<span class="add">
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>
															</xforms:label>
															<xxforms:show ev:event="DOMActivate" dialog="titlestmt-objects"></xxforms:show>
														</xforms:trigger>
													</span>
													<xxforms:dialog id="titlestmt-objects" appearance="full" level="modal" close="true" draggable="true" visible="false">
														<xforms:label>Title Statement Elements</xforms:label>
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>Subtitle</xforms:label>
															<xforms:insert ev:event="DOMActivate" context="." nodeset="if (ead:subtitle) then ead:subtitle[last()] else ead:titleproper"
																origin="instance('subtitle-template')"></xforms:insert>
														</xforms:trigger>
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>Finding Aid Author</xforms:label>
															<xforms:insert ev:event="DOMActivate" context="." nodeset="if (ead:subtitle) then ead:subtitle else ead:titleproper"
																origin="instance('author-template')"></xforms:insert>
														</xforms:trigger>
														<xforms:group ref=".[count(ead:sponsor) &lt; 1]">
															<xforms:trigger appearance="minimal">
																<xforms:label>
																	<span class="glyphicon glyphicon-plus"></span>Sponsor</xforms:label>
																<xforms:insert ev:event="DOMActivate" context="."
																	nodeset="if (ead:author) then ead:author else if (ead:subtitle) then ead:subtitle else ead:titleproper"
																	origin="instance('sponsor-template')"></xforms:insert>
															</xforms:trigger>
														</xforms:group>
													</xxforms:dialog>
													<div>
														<xforms:input ref="ead:titleproper">
															<xforms:label>Finding Aid Title</xforms:label>
															<xforms:alert>Required</xforms:alert>
														</xforms:input>
													</div>
													<!-- subtitle -->
													<xforms:group ref="ead:subtitle">
														<div>
															<xforms:input ref=".">
																<xforms:label>Subtitle</xforms:label>
															</xforms:input>
															<xforms:trigger appearance="minimal">
																<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
																<xforms:label>
																	<span class="glyphicon glyphicon-remove"></span>
																</xforms:label>
															</xforms:trigger>
														</div>
													</xforms:group>
													<!-- author -->
													<xforms:repeat nodeset="ead:author">
														<div>
															<xforms:input ref=".">
																<xforms:label>Finding Aid Author</xforms:label>
																<xforms:alert>Required</xforms:alert>
															</xforms:input>
															<xforms:group ref=".[count(../ead:author) &gt; 1]">
																<xforms:trigger appearance="minimal">
																	<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
																	<xforms:label>
																		<span class="glyphicon glyphicon-remove"></span>
																	</xforms:label>
																</xforms:trigger>
															</xforms:group>
														</div>
													</xforms:repeat>
													<!-- sponsor -->
													<xforms:group ref="ead:sponsor">
														<div>
															<xforms:input ref=".">
																<xforms:label>Sponsor</xforms:label>
															</xforms:input>
															<xforms:trigger appearance="minimal">
																<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
																<xforms:label>
																	<span class="glyphicon glyphicon-remove"></span>
																</xforms:label>
															</xforms:trigger>
														</div>
													</xforms:group>
												</div>
											</xforms:group>
											<!-- edition stmt -->
											<xforms:group ref="ead:editionstmt">
												<div class="subsection">
													<h3>Edition Statement</h3>
													<xforms:trigger appearance="minimal">
														<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
														<xforms:label>
															<span class="glyphicon glyphicon-remove"></span>
														</xforms:label>
													</xforms:trigger>
													<div>
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>Paragraph</xforms:label>
															<xforms:insert ev:event="DOMActivate" context="." origin="instance('p-template')"></xforms:insert>
														</xforms:trigger>
													</div>
													<xforms:group nodeset="ead:edition">
														<div>
															<xforms:input ref=".">
																<xforms:label>Edition</xforms:label>
																<xforms:alert>Required</xforms:alert>
															</xforms:input>
														</div>
													</xforms:group>
													<!-- paragraph -->
													<xforms:repeat nodeset="ead:p">
														<eaditor:p></eaditor:p>
													</xforms:repeat>
												</div>
											</xforms:group>
											<!-- publication statement -->
											<xforms:group ref="ead:publicationstmt">
												<div class="subsection">
													<h3>Publication Statement</h3>
													<span class="add">
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>
															</xforms:label>
															<xxforms:show ev:event="DOMActivate" dialog="publicationstmt-objects"></xxforms:show>
														</xforms:trigger>
													</span>
													<xxforms:dialog id="publicationstmt-objects" appearance="full" level="modal" close="true" draggable="true" visible="false">
														<xforms:label>Publication Statement Elements</xforms:label>
														<xforms:group ref=".[count(ead:address) &lt; 1]">
															<xforms:trigger appearance="minimal">
																<xforms:label>
																	<span class="glyphicon glyphicon-plus"></span>Institutional Address</xforms:label>
																<xforms:insert ev:event="DOMActivate" context="." origin="instance('address-template')"></xforms:insert>
															</xforms:trigger>
														</xforms:group>
														<xforms:group ref=".[count(ead:date) &lt; 1]">
															<xforms:trigger appearance="minimal">
																<xforms:label>
																	<span class="glyphicon glyphicon-plus"></span>Date</xforms:label>
																<xforms:insert ev:event="DOMActivate" context="." origin="instance('date-template')"></xforms:insert>
															</xforms:trigger>
														</xforms:group>
														<xforms:group ref=".[count(ead:num) &lt; 1]">
															<xforms:trigger appearance="minimal">
																<xforms:label>
																	<span class="glyphicon glyphicon-plus"></span>Number</xforms:label>
																<xforms:insert ev:event="DOMActivate" context="." origin="instance('num-template')"></xforms:insert>
															</xforms:trigger>
														</xforms:group>
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>Paragraph</xforms:label>
															<xforms:insert ev:event="DOMActivate" context="." origin="instance('p-template')"></xforms:insert>
														</xforms:trigger>
														<xforms:group ref=".[count(ead:publisher) &lt; 1]">
															<xforms:trigger appearance="minimal">
																<xforms:label>
																	<span class="glyphicon glyphicon-plus"></span>Publisher</xforms:label>
																<xforms:insert ev:event="DOMActivate" context="." origin="instance('publisher-template')"></xforms:insert>
															</xforms:trigger>
														</xforms:group>
													</xxforms:dialog>
													<xforms:group ref=".[count(child::node()) &lt; 1]">
														<div class="warning"><b>Warning:</b> Element must contain content.</div>
													</xforms:group>
													<!-- publisher -->
													<xforms:group ref="ead:publisher">
														<div>
															<xforms:input ref=".">
																<xforms:label>Publisher</xforms:label>
																<xforms:alert>Required</xforms:alert>
															</xforms:input>
														</div>
													</xforms:group>
													<!-- address -->
													<xforms:group ref="ead:address">
														<eaditor:address></eaditor:address>
													</xforms:group>
													<!-- date -->
													<xforms:group ref="ead:date">
														<eaditor:date></eaditor:date>
													</xforms:group>
													<!-- num -->
													<xforms:group ref="ead:num">
														<eaditor:num></eaditor:num>
													</xforms:group>
													<!-- paragraph -->
													<xforms:repeat nodeset="ead:p">
														<eaditor:p></eaditor:p>
													</xforms:repeat>
												</div>
											</xforms:group>
											<!-- series statement -->
											<xforms:group ref="ead:seriesstmt">
												<div class="subsection">
													<h3>Series Statement</h3>
													<xforms:trigger appearance="minimal">
														<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
														<xforms:label>
															<span class="glyphicon glyphicon-remove"></span>
														</xforms:label>
													</xforms:trigger>
													<span class="add">
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>
															</xforms:label>
															<xxforms:show ev:event="DOMActivate" dialog="seriesstmt-objects"></xxforms:show>
														</xforms:trigger>
													</span>
													<xxforms:dialog id="seriesstmt-objects" appearance="full" level="modal" close="true" draggable="true" visible="false">
														<xforms:label>Series Statement Elements</xforms:label>
														<xforms:group ref=".[count(ead:num) &lt; 1]">
															<xforms:trigger appearance="minimal">
																<xforms:label>
																	<span class="glyphicon glyphicon-plus"></span>Number</xforms:label>
																<xforms:insert ev:event="DOMActivate" context="." origin="instance('num-template')"></xforms:insert>
															</xforms:trigger>
														</xforms:group>
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>Paragraph</xforms:label>
															<xforms:insert ev:event="DOMActivate" context="." nodeset="./child::node()[last()]" origin="instance('p-template')"></xforms:insert>
														</xforms:trigger>
														<xforms:group ref=".[count(ead:titleproper) &lt; 1]">
															<xforms:trigger appearance="minimal">
																<xforms:label>
																	<span class="glyphicon glyphicon-plus"></span>Title</xforms:label>
																<xforms:insert ev:event="DOMActivate" context="." origin="instance('titleproper-template')"></xforms:insert>
															</xforms:trigger>
														</xforms:group>
													</xxforms:dialog>
													<xforms:group ref=".[count(child::node()) &lt; 1]">
														<div class="warning"><b>Warning:</b> Element must contain content.</div>
													</xforms:group>
													<!-- titleproper -->
													<xforms:group ref="ead:titleproper">
														<eaditor:titleproper></eaditor:titleproper>
													</xforms:group>
													<!-- num -->
													<xforms:group ref="ead:num">
														<eaditor:num></eaditor:num>
													</xforms:group>
													<!-- p -->
													<xforms:repeat nodeset="ead:p">
														<eaditor:p></eaditor:p>
													</xforms:repeat>
												</div>
											</xforms:group>
											<xforms:group ref="ead:notestmt">
												<div class="subsection">
													<h3>Note Statement</h3>
													<xforms:trigger appearance="minimal">
														<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
														<xforms:label>
															<span class="glyphicon glyphicon-remove"></span>
														</xforms:label>
													</xforms:trigger>
													<div>
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<span class="glyphicon glyphicon-plus"></span>Note</xforms:label>
															<xforms:insert ev:event="DOMActivate" context="." nodeset="child::node()[last()]" origin="instance('note-template')"></xforms:insert>
														</xforms:trigger>
													</div>
													<xforms:group ref=".[count(child::ead:note) &lt; 1]">
														<div class="warning"><b>Warning:</b> Note Statement must contain at least one Note.</div>
													</xforms:group>
													<xforms:repeat nodeset="ead:note">
														<eaditor:note></eaditor:note>
													</xforms:repeat>
												</div>
											</xforms:group>
										</xforms:group>
									</div>
									<!-- profile description -->
									<xforms:group ref="ead:profiledesc">
										<div class="section">
											<h2>Profile Description</h2>
											<span class="add">
												<xforms:trigger appearance="minimal">
													<xforms:label>
														<span class="glyphicon glyphicon-plus"></span>
													</xforms:label>
													<xxforms:show ev:event="DOMActivate" dialog="profiledesc-objects"></xxforms:show>
												</xforms:trigger>
											</span>
											<xxforms:dialog id="profiledesc-objects" appearance="full" level="modal" close="true" draggable="true" visible="false">
												<xforms:label>Profile Description Elements</xforms:label>
												<xforms:group ref=".[count(ead:descrules) &lt; 1]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<span class="glyphicon glyphicon-plus"></span>Descriptive Rules</xforms:label>
														<xforms:insert ev:event="DOMActivate" context="."
															nodeset="if (ead:creation) then ead:creation else if (ead:langusage) then ./child::node()[position() = 1] else node()"
															origin="instance('descrules-template')"></xforms:insert>
													</xforms:trigger>
												</xforms:group>
												<xforms:group ref=".[count(ead:langusage) &lt; 1]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<span class="glyphicon glyphicon-plus"></span>Language Usage</xforms:label>
														<xforms:insert ev:event="DOMActivate" context="."
															nodeset="if (ead:descrules) then ead:descrules else if (ead:creation) then ead:creation else if (ead:descrules) then ./child::node()[last()] else node()"
															origin="instance('langusage-template')"></xforms:insert>
													</xforms:trigger>
												</xforms:group>
											</xxforms:dialog>
											<xforms:group ref="ead:creation">
												<div>
													<xforms:input ref=".">
														<xforms:label>Creation</xforms:label>
														<xforms:alert>Required</xforms:alert>
													</xforms:input>
												</div>
											</xforms:group>
											<xforms:repeat nodeset="ead:descrules">
												<div>
													<xforms:input ref=".">
														<xforms:label>Descriptive Rules</xforms:label>
													</xforms:input>
													<xforms:trigger appearance="minimal">
														<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
														<xforms:label>
															<span class="glyphicon glyphicon-remove"></span>
														</xforms:label>
													</xforms:trigger>
												</div>
											</xforms:repeat>
											<xforms:repeat nodeset="ead:langusage">
												<div>
													<xforms:input ref=".">
														<xforms:label>Language Usage</xforms:label>
													</xforms:input>
													<xforms:trigger appearance="minimal">
														<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
														<xforms:label>
															<span class="glyphicon glyphicon-remove"></span>
														</xforms:label>
													</xforms:trigger>
												</div>
											</xforms:repeat>
										</div>
									</xforms:group>
									<xforms:group ref="ead:revisiondesc">
										<div class="section">
											<h2>Revision Description</h2>
											<xforms:trigger appearance="minimal">
												<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
												<xforms:label>
													<span class="glyphicon glyphicon-remove"></span>
												</xforms:label>
											</xforms:trigger>
											<div>
												<xforms:trigger appearance="minimal">
													<xforms:label>
														<span class="glyphicon glyphicon-plus"></span>Change</xforms:label>
													<xforms:insert ev:event="DOMActivate" context="." origin="instance('change-template')"></xforms:insert>
												</xforms:trigger>
											</div>
											<xforms:repeat nodeset="ead:change">
												<div class="pair_div">
													<!-- date -->
													<xforms:group ref="ead:date">
														<eaditor:date></eaditor:date>
													</xforms:group>
													<div>
														<xforms:input ref="ead:item">
															<xforms:label>Item</xforms:label>
														</xforms:input>
													</div>
													<xforms:group ref=".[count(parent::node()/ead:change) &gt; 1]">
														<xforms:trigger appearance="minimal" style="float:right;">
															<xforms:delete ev:event="DOMActivate" nodeset="."></xforms:delete>
															<xforms:label>
																<span class="glyphicon glyphicon-remove"></span>
															</xforms:label>
														</xforms:trigger>
													</xforms:group>
												</div>
											</xforms:repeat>
										</div>
									</xforms:group>
								</xforms:group>
							</fr:tab>
							<!--**************************************** END EADHEADER **********************************-->
							<!--**************************************** ARCHDESC **********************************-->
							<fr:tab bind="archdesc-tab">
								<fr:label>Collection Info</fr:label>
								<div class="row">
									<div class="col-md-12">
										<h1>Collection Info</h1>										
										<div>
											<xforms:select1 ref="@level">
												<xforms:label>Level</xforms:label>
												<xforms:itemset nodeset="instance('level-template')/level">
													<xforms:label ref="."></xforms:label>
													<xforms:value ref="@value"></xforms:value>
												</xforms:itemset>
											</xforms:select1>
										</div>
									</div>									
									<div class="col-md-6">
										<xforms:group ref="ead:did">
											<eaditor:did></eaditor:did>
										</xforms:group>
									</div>
									<div class="col-md-6">
										<eaditor:component-level></eaditor:component-level>
									</div>									
								</div>
							</fr:tab>
							<!--**************************************** DSC **********************************-->
							<fr:tab id="dsc-tab">
								<fr:label>Inventory</fr:label>
								<xforms:group ref="instance('guide')/ead:archdesc">
									<h2>Inventory</h2>
									<xforms:group ref=".[ead:dsc]">
										<xforms:trigger appearance="minimal">
											<xforms:dispatch target="remove-dsc" name="fr-show" ev:event="DOMActivate"></xforms:dispatch>
											<xforms:label>
												<span class="glyphicon glyphicon-remove"></span>
											</xforms:label>
										</xforms:trigger>
									</xforms:group>
									<xforms:group ref=".[count(ead:otherfindaid[@type='eaditor_upload']) = 0]">
										<xforms:trigger appearance="minimal">
											<xforms:label><span class="glyphicon glyphicon-upload"></span>Upload Container List</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<!-- insert dsc if it doesn't exist -->
												<xforms:insert context="." nodeset="./child::node()[last()]" origin="instance('upload-template')"></xforms:insert>
											</xforms:action>
										</xforms:trigger>
									</xforms:group>
									
									<div>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<span class="glyphicon glyphicon-plus"></span>Component</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<!-- insert dsc if it doesn't exist -->
												<xforms:insert context="." nodeset="./child::node()[last()]" origin="instance('dsc-template')" if="not(ead:dsc)"></xforms:insert>
												<xforms:insert context="ead:dsc" nodeset="./child::node()[last()]" origin="instance('c-template')"></xforms:insert>
												<xforms:setvalue ref="ead:dsc/ead:c[last()]/@id" value="concat('c_', string(digest( string( random( true ) ), 'MD5', 'hex' )))"></xforms:setvalue>
											</xforms:action>
										</xforms:trigger>
									</div>
									<xforms:group ref="ead:otherfindaid[@type='eaditor_upload']">
										<eaditor:otherfindaid/>
									</xforms:group>
									<xforms:group ref="ead:dsc">
										<xforms:group ref=".[count(ead:c) = 0]">
											<div class="alert-danger alert alert-box"><span class="glyphicon glyphicon-exclamation-sign"></span><strong>Alert:</strong> The DSC must not be empty.</div>
										</xforms:group>
										
										<xforms:repeat nodeset="ead:c">
											<eaditor:c></eaditor:c>
										</xforms:repeat>
									</xforms:group>
									
									<fr:alert-dialog id="remove-dsc">
										<fr:label>Remove DSC</fr:label>
										<fr:message>Are you sure you want to remove the DSC and all components?</fr:message>
										<fr:negative-choice>
											<fr:label>No</fr:label>
										</fr:negative-choice>
										<fr:positive-choice>
											<fr:label>Yes</fr:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:delete nodeset="ead:dsc"></xforms:delete>											
											</xforms:action>
										</fr:positive-choice>
									</fr:alert-dialog>
								</xforms:group>
							</fr:tab>
							<!--<fr:tab id="preview">
								<fr:label>XML Preview</fr:label>
								<h1>XML Preview</h1>
								<fr:xforms-inspector/>
							</fr:tab>-->
							<!--**************************************** END ARCHDESC **********************************-->
						</fr:tabview>
					</div>
				</div>
				<div class="col-md-12">
					<div class="submission">
						<xforms:submit submission="save-guide" appearance="minimal">
							<xforms:label><span class="glyphicon glyphicon-floppy-disk"></span>Save</xforms:label>
						</xforms:submit>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
